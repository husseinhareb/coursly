<?php
// src/Entity/User.php

namespace App\Entity;

use Doctrine\Common\Collections\ArrayCollection;
use Doctrine\Common\Collections\Collection;
use Doctrine\ORM\Mapping as ORM;
use App\Repository\UserRepository;
use Symfony\Component\Security\Core\User\UserInterface;
use Symfony\Component\Security\Core\User\PasswordAuthenticatedUserInterface;

#[ORM\Entity(repositoryClass: UserRepository::class)]
#[ORM\Table(name: 'user')]
class User implements UserInterface, PasswordAuthenticatedUserInterface
{
    #[ORM\Id]
    #[ORM\GeneratedValue]
    #[ORM\Column(type: 'integer')]
    private ?int $id = null;

    #[ORM\Column(type: 'string', length: 180, unique: true)]
    private string $email;

    #[ORM\Column(type: 'string', length: 180, unique: true)]
    private string $username;

    /**
     * @var Collection<int, Role>
     */
    #[ORM\ManyToMany(targetEntity: Role::class, inversedBy: 'users')]
    #[ORM\JoinTable(name: 'user_role')]
    private Collection $roles;

    #[ORM\Column(type: 'string')]
    private string $password;

    #[ORM\Column(type: 'string', length: 255, nullable: true)]
    private ?string $profilePic = null;

    #[ORM\Column(type: 'string', length: 255)]
    private string $firstName;

    #[ORM\Column(type: 'string', length: 255)]
    private string $lastName;

    #[ORM\Column(type: 'boolean')]
    private bool $passwordAutoGenerated = true;

    #[ORM\Column(type: 'string', length: 20, nullable: true)]
    private ?string $phoneNumber = null;

    #[ORM\Column(type: 'string', length: 255, nullable: true)]
    private ?string $address = null;

    #[ORM\Column(type: 'datetime_immutable')]
    private \DateTimeImmutable $createdAt;

    #[ORM\Column(type: 'datetime_immutable')]
    private \DateTimeImmutable $updatedAt;

    /**
     * @var Collection<int, Enrollment>
     */
    #[ORM\OneToMany(mappedBy: 'user', targetEntity: Enrollment::class, cascade: ['persist', 'remove'])]
    private Collection $enrollments;

    /**
     * @var Collection<int, UserCourseAccess>
     */
    #[ORM\OneToMany(mappedBy: 'user', targetEntity: UserCourseAccess::class, cascade: ['persist', 'remove'])]
    private Collection $accessLogs;

    public function __construct()
    {
        $this->roles       = new ArrayCollection();
        $this->enrollments = new ArrayCollection();
        $this->accessLogs  = new ArrayCollection();
        $this->createdAt   = new \DateTimeImmutable();
        $this->updatedAt   = new \DateTimeImmutable();
    }

    public function getId(): ?int
    {
        return $this->id;
    }

    public function getEmail(): string
    {
        return $this->email;
    }
    public function setEmail(string $email): self
    {
        $this->email     = $email;
        $this->updatedAt = new \DateTimeImmutable();
        return $this;
    }

    public function getUserIdentifier(): string
    {
        return $this->email;
    }

    public function getUsername(): string
    {
        return $this->username;
    }
    public function setUsername(string $username): self
    {
        $this->username  = $username;
        $this->updatedAt = new \DateTimeImmutable();
        return $this;
    }

    /**
     * @return string[]
     */
    public function getRoles(): array
    {
        $names = $this->roles
            ->map(fn(Role $r) => $r->getName())
            ->toArray();

        $names[] = 'ROLE_USER';
        return array_unique($names);
    }

    /**
     * @return Collection<int, Role>
     */
    public function getRoleEntities(): Collection
    {
        return $this->roles;
    }

    public function addRole(Role $role): self
    {
        if (!$this->roles->contains($role)) {
            $this->roles->add($role);
            $role->getUsers()->add($this);
        }
        return $this;
    }
    public function removeRole(Role $role): self
    {
        if ($this->roles->removeElement($role)) {
            $role->getUsers()->removeElement($this);
        }
        return $this;
    }

    public function getPassword(): string
    {
        return $this->password;
    }
    public function setPassword(string $password): self
    {
        $this->password              = $password;
        $this->passwordAutoGenerated = false;
        $this->updatedAt             = new \DateTimeImmutable();
        return $this;
    }

    public function eraseCredentials(): void
    {
        // no sensitive data stored here
    }

    public function getProfilePic(): ?string
    {
        return $this->profilePic;
    }
    public function setProfilePic(?string $profilePic): self
    {
        $this->profilePic = $profilePic;
        $this->updatedAt  = new \DateTimeImmutable();
        return $this;
    }

    public function getFirstName(): string
    {
        return $this->firstName;
    }
    public function setFirstName(string $firstName): self
    {
        $this->firstName  = $firstName;
        $this->updatedAt  = new \DateTimeImmutable();
        return $this;
    }

    public function getLastName(): string
    {
        return $this->lastName;
    }
    public function setLastName(string $lastName): self
    {
        $this->lastName   = $lastName;
        $this->updatedAt  = new \DateTimeImmutable();
        return $this;
    }

    public function isPasswordAutoGenerated(): bool
    {
        return $this->passwordAutoGenerated;
    }
    public function setPasswordAutoGenerated(bool $flag): self
    {
        $this->passwordAutoGenerated = $flag;
        return $this;
    }

    public function getPhoneNumber(): ?string
    {
        return $this->phoneNumber;
    }
    public function setPhoneNumber(?string $phoneNumber): self
    {
        $this->phoneNumber = $phoneNumber;
        $this->updatedAt   = new \DateTimeImmutable();
        return $this;
    }

    public function getAddress(): ?string
    {
        return $this->address;
    }
    public function setAddress(?string $address): self
    {
        $this->address    = $address;
        $this->updatedAt  = new \DateTimeImmutable();
        return $this;
    }

    public function getCreatedAt(): \DateTimeImmutable
    {
        return $this->createdAt;
    }
    public function getUpdatedAt(): \DateTimeImmutable
    {
        return $this->updatedAt;
    }
    public function setUpdatedAt(\DateTimeImmutable $dt): self
    {
        $this->updatedAt = $dt;
        return $this;
    }

    /**
     * @return Collection<int, Enrollment>
     */
    public function getEnrollments(): Collection
    {
        return $this->enrollments;
    }
    public function addEnrollment(Enrollment $e): self
    {
        if (!$this->enrollments->contains($e)) {
            $this->enrollments->add($e);
            $e->setUser($this);
        }
        return $this;
    }
    public function removeEnrollment(Enrollment $e): self
    {
        if ($this->enrollments->removeElement($e)) {
            if ($e->getUser() === $this) {
                $e->setUser(null);
            }
        }
        return $this;
    }

    /**
     * @return Collection<int, UserCourseAccess>
     */
    public function getAccessLogs(): Collection
    {
        return $this->accessLogs;
    }
    public function logAccess(UserCourseAccess $log): self
    {
        if (!$this->accessLogs->contains($log)) {
            $this->accessLogs->add($log);
            $log->setUser($this);
        }
        return $this;
    }
}
