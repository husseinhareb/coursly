{% extends 'base.html.twig' %}

{% block title %}{{ 'profile.title'|trans }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('styles/profile.css') }}">
{% endblock %}

{% block body %}
<main class="profile-content">
    <h1>{{ 'profile.header'|trans }}</h1>

    {# Display any flash messages #}
    {% for label, flashes in app.flashes %}
        {% for flash in flashes %}
            <div class="alert alert-{{ label }}">{{ flash }}</div>
        {% endfor %}
    {% endfor %}

    {# Profile Picture Section #}
    <div class="profile-picture">
        {% if user.profilePic %}
            <img src="{{ asset('uploads/profile_pics/' ~ user.profilePic) }}" alt="{{ 'profile.picture_alt'|trans }}" class="profile-img">
        {% else %}
            <p class="no-picture">{{ 'profile.no_picture'|trans }}</p>
        {% endif %}
    </div>

    {# Read-Only View Section #}
    <div id="profile-view">
        <ul class="user-info">
            <li><strong>{{ 'profile.first_name'|trans }}:</strong> {{ user.firstName }}</li>
            <li><strong>{{ 'profile.last_name'|trans }}:</strong> {{ user.lastName }}</li>
            <li><strong>{{ 'profile.email'|trans }}:</strong> {{ user.email }}</li>
            <li>
                <strong>{{ 'profile.phone_number'|trans }}:</strong>
                {{ user.phoneNumber ?: ('profile.not_provided'|trans) }}
            </li>
            <li>
                <strong>{{ 'profile.address'|trans }}:</strong>
                {{ user.address ?: ('profile.not_provided'|trans) }}
            </li>
            <li>
                <strong>{{ 'profile.roles'|trans }}:</strong> {{ user.roles|join(', ') }}
            </li>
            <li>
                <strong>{{ 'profile.enrolled_courses'|trans }}:</strong>
                <a href="{{ path('admin_manage_enrollments', {'username': app.user.username, 'id': user.id}) }}" class="btn-manage-enrollments">
                    {{ 'profile.manage_enrollments'|trans }}
                </a>
            </li>
        </ul>
        <button type="button" id="edit-button" class="btn btn-primary">{{ 'profile.edit_profile'|trans }}</button>
        <a href="{{ path('app_change_password', {'username': app.user.username}) }}" class="btn btn-secondary">{{ 'profile.change_password'|trans }}</a>
    </div>

    {# Edit Form Section #}
    <div id="profile-edit" style="display: none;">
        {{ form_start(form) }}
            {{ form_row(form.firstName) }}
            {{ form_row(form.lastName) }}
            {{ form_row(form.phoneNumber) }}
            {{ form_row(form.address) }}
            {{ form_row(form.profilePic) }}
            <button type="submit" class="btn btn-success">{{ 'profile.save'|trans }}</button>
        {{ form_end(form) }}

        <button type="button" id="cancel-button" class="btn btn-secondary">{{ 'profile.cancel'|trans }}</button>
    </div>
</main>

<script>
    function initProfileToggle() {
        document.body.removeEventListener('click', profileToggleHandler);
        document.body.addEventListener('click', profileToggleHandler);
    }

    function profileToggleHandler(e) {
        if (e.target.closest('#edit-button')) {
            document.getElementById('profile-view').style.display = 'none';
            document.getElementById('profile-edit').style.display = 'block';
        }
        if (e.target.closest('#cancel-button')) {
            document.getElementById('profile-edit').style.display = 'none';
            document.getElementById('profile-view').style.display = 'block';
        }
    }

    document.addEventListener('turbo:load', initProfileToggle);
    document.addEventListener('DOMContentLoaded', initProfileToggle);
</script>
{% endblock %}
