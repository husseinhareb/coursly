{% extends 'base.html.twig' %}

{% block title %}My Profile{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('styles/profile.css') }}">
{% endblock %}

{% block body %}
<main class="profile-content">
    <h1>Your Profile</h1>

    {# Flash messages #}
    {% for label, flashes in app.flashes %}
        {% for flash in flashes %}
            <div class="alert alert-{{ label }}">{{ flash }}</div>
        {% endfor %}
    {% endfor %}

    {# Profile Picture #}
    <div class="profile-picture">
        {% if user.profilePic %}
            <img 
                src="{{ asset('uploads/profile_pics/' ~ user.profilePic) }}" 
                alt="Profile Picture" 
                class="profile-img"
            >
        {% else %}
            <p class="no-picture">No profile picture available.</p>
        {% endif %}
    </div>

    {# Determine whether to show the edit form due to validation errors #}
    {% set showEditForm = form.vars.submitted and not form.vars.valid %}

    {# Read-Only View Section #}
    <div id="profile-view" style="display: {{ showEditForm ? 'none' : 'block' }};">
        <ul class="user-info">
            <li><strong>First Name:</strong> {{ user.firstName }}</li>
            <li><strong>Last Name:</strong> {{ user.lastName }}</li>
            <li><strong>Email:</strong> {{ user.email }}</li>
            <li><strong>Phone Number:</strong> {{ user.phoneNumber ?: 'Not provided' }}</li>
            <li><strong>Address:</strong> {{ user.address ?: 'Not provided' }}</li>
            <li><strong>Roles:</strong> {{ user.roles|join(', ') }}</li>
            <li>
                <strong>Enrolled Courses:</strong>
                {% if user.enrolledCourses is not empty %}
                    {{ user.enrolledCourses|join(', ') }}
                {% else %}
                    None
                {% endif %}
            </li>
        </ul>
        <button type="button" id="edit-button" class="btn btn-primary">
            Edit Profile
        </button>
        <a href="{{ path('app_change_password' , {'username': app.user.username})  }}" class="btn btn-secondary">
            Change Password
        </a>
    </div>

    {# Edit Form Section #}
    <div id="profile-edit" style="display: {{ showEditForm ? 'block' : 'none' }};">
        {{ form_start(form) }}
            {{ form_row(form.firstName) }}
            {{ form_row(form.lastName) }}
            {{ form_row(form.phoneNumber) }}
            {{ form_row(form.address) }}
            {{ form_row(form.profilePic) }}

            <button type="submit" class="btn btn-success">Save</button>
        {{ form_end(form) }}

        <button type="button" id="cancel-button" class="btn btn-secondary">
            Cancel
        </button>
    </div>
</main>

{# JavaScript to toggle between view and edit modes #}
<script>
    function initProfileToggle() {
        document.body.removeEventListener('click', profileToggleHandler);
        document.body.addEventListener('click', profileToggleHandler);
    }

    function profileToggleHandler(e) {
        if (e.target.closest('#edit-button')) {
            document.getElementById('profile-view').style.display = 'none';
            document.getElementById('profile-edit').style.display = 'block';
        }
        if (e.target.closest('#cancel-button')) {
            document.getElementById('profile-edit').style.display = 'none';
            document.getElementById('profile-view').style.display = 'block';
        }
    }

    document.addEventListener('turbo:load', initProfileToggle);
    document.addEventListener('DOMContentLoaded', initProfileToggle);
</script>
{% endblock %}
